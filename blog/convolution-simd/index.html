<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        
        
        

        <link rel="stylesheet" href="/css/style.css"/>
        <link rel="stylesheet" href="/line-awesome/css/line-awesome.min.css"/>
        <link rel="icon" type="image/x-icon" href="/favicon.png">
        <script src="/js/main.js" defer></script>
        
    <title>Performance optimization, and how to do it wrong | Just wing it</title>
    <meta name="description" content="Optimization is hard. And sometimes, the compiler makes it even harder.">


        
            <link rel="alternate" type="application/rss+xml" title="RSS" href="https://genna.win/rss.xml">
            <link rel="alternate" type="application/atom+xml" title="Atom" href="https://genna.win/atom.xml">
        
    </head>

    <body class="bg-white dark:bg-zinc-900 transition ease-in-out">
        <section>
            
    
<div class="sticky top-0 bg-slate-100 dark:bg-zinc-800">
    <div class="container mx-auto flex place-content-between
        py-4 lg:py-8 font-sans text-2xl text-slate-900
        dark:text-slate-300 px-4">
        <div class="flex">
            
            
            
            
            <a class="m-0 p-0 text-slate-900 hover:text-slate-700
                            dark:text-slate-300 dark:hover:text-slate-200" href="&#x2F;blog&#x2F;">
                /blog
            </a>
            
            
            
            
            
            
        </div>
        <div class="flex gap-4">
            <div id="back-to-top" class="hidden cursor-pointer">
                <i class="las la-level-up-alt"></i>
            </div>
            <a href="/" aria-label="Home"><i class="las la-home"></i></a>
            <div id="darkmode-toggle" class="cursor-pointer">
                <div class="hidden dark:inline">
                    <i class="las la-sun"></i>
                </div>
                <div class="inline dark:hidden">
                    <i class="las la-moon"></i>
                </div>
            </div>
        </div>
    </div>
</div>

    <div class="container mb-16 px-4">
        <div class="mt-4 font-serif text-slate-600 dark:text-slate-500 text-2xl lg:text-base">
            2025-03-02
        </div>
        <h1 class="w-full mt-4 mb-8 font-serif text-4xl text-slate-900 dark:text-slate-300 lowercase">
            | Performance optimization, and how to do it wrong |
        </h1>
        <div class="w-100 border-t mb-8 border-slate-300 dark:border-slate-700"></div>
        <div class="prose-boring">
            <p>I recently tried to optimize convolutions using
<a href="https://en.wikipedia.org/wiki/Single_instruction,_multiple_data">SIMD</a>
instructions, but what I thought would be a simple task ended up taking me days,
with issue after issue popping up one after another. Some of them make sense in
hindsight, but others were utterly baffling. While the specific examples are for
direct convolution, these considerations apply to pretty much any code with a
hot loop.</p>
<aside>
<i>Note:</i></br>
This blog post is mostly written from memory, since I didn't keep around every version of the code
being discussed. The values in the benchmarks are a rough recreation of the real values.
</aside>
<h2 id="background">Background</h2>
<p>I work on <a href="https://github.com/Tracel-AI/burn">burn</a> and recently wanted to
optimize direct convolution on the <code>burn-ndarray</code> CPU backend.<br />
For convolutions you need to move a two-dimensional kernel across an input
feature map and sum all the values across all input channels. This is repeated
for each output channel. The input can have <code>padding</code> pixels of zero-padding
around the actual data, and the kernel can move in a strided manner (i.e. two
pixels at once). There are many algorithms with different tradeoffs, but I
decided to go with direct convolutions since they don't have memory overhead and
are still very efficient when implemented correctly. The basic outline is that
you have many nested loops, some bounds checks and a very frequently executed
<a href="https://en.wikipedia.org/wiki/Multiply%E2%80%93accumulate_operation#Fused_multiply%E2%80%93add">fused-multiply-add (FMA) instruction</a>.
My initial implementation looked something like this<sup class="footnote-reference" id="fr-1-1"><a href="#fn-1">1</a></sup> (simplified):</p>
<pre data-lang="rust" class="language-rust z-code"><code class="language-rust" data-lang="rust"><span class="z-source z-rust"><span class="z-support z-macro z-rust">iter_range_par!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-constant z-numeric z-integer z-decimal z-rust">0</span><span class="z-punctuation z-separator z-rust">,</span> batch_size <span class="z-keyword z-operator z-arithmetic z-rust">*</span> oc_blocks</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">for_each</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">|</span></span></span><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-variable z-parameter z-rust">k</span><span class="z-punctuation z-section z-parameters z-end z-rust">|</span></span> </span><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-block z-rust">  <span class="z-keyword z-control z-rust">for</span> oh <span class="z-keyword z-operator z-rust">in</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">0</span><span class="z-keyword z-operator z-range z-rust">..</span>out_height <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">    <span class="z-keyword z-control z-rust">for</span> ow_block <span class="z-keyword z-operator z-rust">in</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">0</span><span class="z-keyword z-operator z-range z-rust">..</span>ow_blocks <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">      <span class="z-support z-macro z-rust">seq!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>N <span class="z-keyword z-operator z-rust">in</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">0</span><span class="z-keyword z-operator z-range z-rust">..</span><span class="z-constant z-numeric z-integer z-decimal z-rust">8</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-block z-rust">        <span class="z-storage z-type z-rust">let</span> <span class="z-storage z-modifier z-rust">mut</span> acc<span class="z-keyword z-operator z-rust">~</span>N <span class="z-keyword z-operator z-assignment z-rust">=</span> bias<span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-block z-rust">      </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">
</span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">      <span class="z-keyword z-control z-rust">for</span> ic <span class="z-keyword z-operator z-rust">in</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">0</span><span class="z-keyword z-operator z-range z-rust">..</span>in_channels <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">        <span class="z-keyword z-control z-rust">for</span> kh <span class="z-keyword z-operator z-rust">in</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">0</span><span class="z-keyword z-operator z-range z-rust">..</span>k_height <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">          <span class="z-keyword z-control z-rust">if</span> <span class="z-keyword z-operator z-logical z-rust">!</span>in_bounds_h <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">            <span class="z-keyword z-control z-rust">continue</span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">          </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">
</span></span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">          <span class="z-keyword z-control z-rust">for</span> kw <span class="z-keyword z-operator z-rust">in</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">0</span><span class="z-keyword z-operator z-range z-rust">..</span>k_width <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">            <span class="z-storage z-type z-rust">let</span> f0 <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-support z-function z-rust">vload</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-operator z-bitwise z-rust">&amp;</span>weights<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">[</span>ic<span class="z-punctuation z-separator z-rust">,</span> kh<span class="z-punctuation z-separator z-rust">,</span> kw<span class="z-punctuation z-separator z-rust">,</span> oc<span class="z-punctuation z-section z-group z-end z-rust">]</span></span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">            <span class="z-support z-macro z-rust">seq!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>N <span class="z-keyword z-operator z-rust">in</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">0</span><span class="z-keyword z-operator z-range z-rust">..</span><span class="z-constant z-numeric z-integer z-decimal z-rust">8</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-block z-rust">              <span class="z-keyword z-control z-rust">if</span> in_bounds_w <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span></span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">                <span class="z-storage z-type z-rust">let</span> i<span class="z-keyword z-operator z-rust">~</span>N <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-support z-function z-rust">splat</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>x<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">[</span>ic<span class="z-punctuation z-separator z-rust">,</span> ih<span class="z-punctuation z-separator z-rust">,</span> iw <span class="z-keyword z-operator z-arithmetic z-rust">+</span> N<span class="z-punctuation z-section z-group z-end z-rust">]</span></span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span></span></span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">                acc<span class="z-keyword z-operator z-rust">~</span>N <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-path z-rust">E<span class="z-punctuation z-accessor z-rust">::</span></span>vmuladd<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>simd<span class="z-punctuation z-separator z-rust">,</span> i<span class="z-keyword z-operator z-rust">~</span>N<span class="z-punctuation z-separator z-rust">,</span> f0<span class="z-punctuation z-separator z-rust">,</span> acc<span class="z-keyword z-operator z-rust">~</span>N</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span></span></span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">              </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></span></span></span></span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-block z-rust">            </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">          </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">        </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">      </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">
</span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">      <span class="z-support z-macro z-rust">seq!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>N <span class="z-keyword z-operator z-rust">in</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">0</span><span class="z-keyword z-operator z-range z-rust">..</span><span class="z-constant z-numeric z-integer z-decimal z-rust">8</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-block z-rust">        <span class="z-keyword z-control z-rust">if</span> ow <span class="z-keyword z-operator z-arithmetic z-rust">+</span> N <span class="z-keyword z-operator z-comparison z-rust">&gt;=</span> out_width <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">          <span class="z-keyword z-control z-rust">continue</span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">        </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-block z-rust">        <span class="z-support z-function z-rust">vstore</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-operator z-bitwise z-rust">&amp;</span><span class="z-storage z-modifier z-rust">mut</span> out<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">[</span>ow <span class="z-keyword z-operator z-arithmetic z-rust">+</span> N<span class="z-punctuation z-separator z-rust">,</span> oc<span class="z-punctuation z-section z-group z-end z-rust">]</span></span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span><span class="z-punctuation z-separator z-rust">,</span> acc<span class="z-keyword z-operator z-rust">~</span>N</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-block z-rust">      </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">  </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></code></pre>
<p>In this implementation I use several techniques. In addition to SIMD loads and
fmadds I use the optimized loop order and register blocking (using the
<a href="https://crates.io/crates/seq-macro"><code>seq</code></a> macro) techniques from
<a href="https://arxiv.org/abs/1808.05567">this paper</a>. I finished the implementation,
executed a benchmark, and... it's slower. More than two times slower than a
naive unvectorized<sup class="footnote-reference" id="fr-2-1"><a href="#fn-2">2</a></sup> implementation in fact (~670ms vs ~300ms).</p>
<h2 id="starting-to-investigate">Starting to investigate</h2>
<p>To do this I tried to use various profilers,
<a href="https://github.com/flamegraph-rs/flamegraph">cargo-flamegraph</a>,
<a href="https://github.com/mstange/samply">samply</a> and, after a lot of desperation,
<a href="https://www.amd.com/en/developer/uprof.html">AMD μProf</a>. After a few days of
trying to get useful information out of these profilers (and getting μProf to
work at all), I realized it wasn't getting me anywhere. The flamegraph and
hotspots just didn't seem to make any sense at all.</p>
<p>So what's the next step?</p>
<h2 id="reducing-the-problem">Reducing the problem</h2>
<p>Ok, none of my attempts to profile led to any success. So let's try to reduce
the code to only what's actually needed in the benchmark. The benchmark uses
unpadded, unstrided, undilated and ungrouped convolutions, so I stripped all
padding checks and all stride/dilation calculations - it was faster, but still
slow.</p>
<p>There was one branch left to eliminate: The check for border pixels in the
register-blocking loop.</p>
<p>Just to check I shortened the loop to only consider pixels up to the last
multiple of 8. This yields incorrect results, but should help with debugging
performance.</p>
<pre data-lang="rust" class="language-rust z-code"><code class="language-rust" data-lang="rust"><span class="z-source z-rust"><span class="z-storage z-type z-rust">let</span> ow_blocks <span class="z-keyword z-operator z-assignment z-rust">=</span> out_width <span class="z-keyword z-operator z-arithmetic z-rust">/</span> ow_b <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> changed from `div_ceil`
</span></span><span class="z-source z-rust"><span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span>...
</span></span><span class="z-source z-rust">
</span><span class="z-source z-rust"><span class="z-keyword z-control z-rust">for</span> ow_block <span class="z-keyword z-operator z-rust">in</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">0</span><span class="z-keyword z-operator z-range z-rust">..</span>ow_blocks <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust">  <span class="z-support z-macro z-rust">seq!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>N <span class="z-keyword z-operator z-rust">in</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">0</span><span class="z-keyword z-operator z-range z-rust">..</span><span class="z-constant z-numeric z-integer z-decimal z-rust">8</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-type z-rust">let</span> <span class="z-storage z-modifier z-rust">mut</span> acc<span class="z-keyword z-operator z-rust">~</span>N <span class="z-keyword z-operator z-assignment z-rust">=</span> bias<span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-block z-rust">  </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust">
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust">  <span class="z-keyword z-control z-rust">for</span> ic <span class="z-keyword z-operator z-rust">in</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">0</span><span class="z-keyword z-operator z-range z-rust">..</span>in_channels <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">    <span class="z-keyword z-control z-rust">for</span> kh <span class="z-keyword z-operator z-rust">in</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">0</span><span class="z-keyword z-operator z-range z-rust">..</span>k_height <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">      <span class="z-keyword z-control z-rust">for</span> kw <span class="z-keyword z-operator z-rust">in</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">0</span><span class="z-keyword z-operator z-range z-rust">..</span>k_width <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">        <span class="z-storage z-type z-rust">let</span> f0 <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-support z-function z-rust">vload</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-operator z-bitwise z-rust">&amp;</span>weights<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">[</span>ic<span class="z-punctuation z-separator z-rust">,</span> kh<span class="z-punctuation z-separator z-rust">,</span> kw<span class="z-punctuation z-separator z-rust">,</span> oc<span class="z-punctuation z-section z-group z-end z-rust">]</span></span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">        <span class="z-support z-macro z-rust">seq!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>N <span class="z-keyword z-operator z-rust">in</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">0</span><span class="z-keyword z-operator z-range z-rust">..</span><span class="z-constant z-numeric z-integer z-decimal z-rust">8</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-block z-rust">          <span class="z-storage z-type z-rust">let</span> i<span class="z-keyword z-operator z-rust">~</span>N <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-support z-function z-rust">splat</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>x<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">[</span>ic<span class="z-punctuation z-separator z-rust">,</span> ih<span class="z-punctuation z-separator z-rust">,</span> iw <span class="z-keyword z-operator z-arithmetic z-rust">+</span> N<span class="z-punctuation z-section z-group z-end z-rust">]</span></span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-block z-rust">          acc<span class="z-keyword z-operator z-rust">~</span>N <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-path z-rust">E<span class="z-punctuation z-accessor z-rust">::</span></span>vmuladd<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>simd<span class="z-punctuation z-separator z-rust">,</span> i<span class="z-keyword z-operator z-rust">~</span>N<span class="z-punctuation z-separator z-rust">,</span> f0<span class="z-punctuation z-separator z-rust">,</span> acc<span class="z-keyword z-operator z-rust">~</span>N</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-block z-rust">        </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">      </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">  </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust">
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust">  <span class="z-support z-macro z-rust">seq!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>N <span class="z-keyword z-operator z-rust">in</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">0</span><span class="z-keyword z-operator z-range z-rust">..</span><span class="z-constant z-numeric z-integer z-decimal z-rust">8</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-block z-rust">    <span class="z-support z-function z-rust">vstore</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-operator z-bitwise z-rust">&amp;</span><span class="z-storage z-modifier z-rust">mut</span> out<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">[</span>ow <span class="z-keyword z-operator z-arithmetic z-rust">+</span> N<span class="z-punctuation z-separator z-rust">,</span> oc<span class="z-punctuation z-section z-group z-end z-rust">]</span></span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span><span class="z-punctuation z-separator z-rust">,</span> acc<span class="z-keyword z-operator z-rust">~</span>N</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-block z-rust">  </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></code></pre>
<p>Executing the benchmark, the code is now <em>significantly faster on a single
thread than the old code with multiple threads!</em></p>
<pre data-lang="txt" class="language-txt z-code"><code class="language-txt" data-lang="txt"><span class="z-text z-plain">Benchmarking - conv2d-input_16x512x512_weight_16x3x3_stride_1
</span><span class="z-text z-plain">―――――――― Result ―――――――――
</span><span class="z-text z-plain">  Timing      full
</span><span class="z-text z-plain">  Samples     40
</span><span class="z-text z-plain">  Mean        205.12ms
</span><span class="z-text z-plain">  Variance    69.420µs
</span><span class="z-text z-plain">  Median      203.24ms
</span><span class="z-text z-plain">  Min         201.12ms
</span><span class="z-text z-plain">  Max         207.23ms
</span><span class="z-text z-plain">―――――――――――――――――――――――――
</span></code></pre>
<p>The problem seems to have been a mixture between spilling registers (as someone
previously focused on GPU, I was shocked to find modern CPUs only have 16 of
them), and too many branches. This is why the profilers didn't lead me anywhere
useful. Branching in modern CPUs is just too complicated to be meaningfully
represented by a profiler hotspot. This is probably the biggest takeaway from
this article: branches are much worse than you think, because the CPU can't
predict more than one<sup class="footnote-reference" id="fr-3-1"><a href="#fn-3">3</a></sup> branch per cycle<sup class="footnote-reference" id="fr-4-1"><a href="#fn-4">4</a></sup>. A single <code>if</code> statement inside a loop is enough to
stop any further instructions from being decoded in that cycle. Since optimal performance requires
2 FMA instructions per cycle (they take 1 cycle with a 5 cycle latency, and Zen 4 has 2 FMA
units), having a branch on every instruction massively hamstrings the performance. This may be
different on Zen 5, but remember, we still have other branches in addition to the <code>ow</code> bounds check
that need predicting. So it's worse than 50% performance in practice.</p>
<p>Alright, now we have a good place to start. Let's start adding things back again
and see where the performance starts getting bad.</p>
<p>First, we need to deal with the remaining pixels after the register-blocking
code. To do this we're going to use a technique, that we'll be using several
more times coming up:</p>
<h2 id="why-have-one-loop-when-you-can-have-two">Why have one loop, when you can have two?</h2>
<p>I mentioned before that I shortened the loop to only deal with clean multiples
of the register-blocking factor. So the way to deal with these remaining pixels
is to just... - <em>add another loop.</em></p>
<p>We add a second unblocked loop that starts at the end of the first loop, and
runs until the edge of the feature map. Since it's not unrolled, we don't need
to add any bounds checks.</p>
<pre data-lang="rust" class="language-rust z-code"><code class="language-rust" data-lang="rust"><span class="z-source z-rust"><span class="z-keyword z-control z-rust">for</span> ow_block <span class="z-keyword z-operator z-rust">in</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">0</span><span class="z-keyword z-operator z-range z-rust">..</span>ow_blocks <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust">  <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span>...
</span></span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span><span class="z-source z-rust"><span class="z-keyword z-control z-rust">for</span> ow <span class="z-keyword z-operator z-rust">in</span> ow_blocks <span class="z-keyword z-operator z-arithmetic z-rust">*</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">8</span><span class="z-keyword z-operator z-range z-rust">..</span>out_width <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust">  <span class="z-storage z-type z-rust">let</span> <span class="z-storage z-modifier z-rust">mut</span> acc <span class="z-keyword z-operator z-assignment z-rust">=</span> bias<span class="z-punctuation z-terminator z-rust">;</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust">
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust">  <span class="z-keyword z-control z-rust">for</span> ic <span class="z-keyword z-operator z-rust">in</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">0</span><span class="z-keyword z-operator z-range z-rust">..</span>in_channels <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">    <span class="z-keyword z-control z-rust">for</span> kh <span class="z-keyword z-operator z-rust">in</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">0</span><span class="z-keyword z-operator z-range z-rust">..</span>k_height <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">      <span class="z-keyword z-control z-rust">for</span> kw <span class="z-keyword z-operator z-rust">in</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">0</span><span class="z-keyword z-operator z-range z-rust">..</span>k_width <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">        <span class="z-storage z-type z-rust">let</span> f0 <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-support z-function z-rust">vload</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-operator z-bitwise z-rust">&amp;</span>weights<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">[</span>ic<span class="z-punctuation z-separator z-rust">,</span> kh<span class="z-punctuation z-separator z-rust">,</span> kw<span class="z-punctuation z-separator z-rust">,</span> oc<span class="z-punctuation z-section z-group z-end z-rust">]</span></span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">        <span class="z-storage z-type z-rust">let</span> i0 <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-support z-function z-rust">splat</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>x<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">[</span>ic<span class="z-punctuation z-separator z-rust">,</span> ih<span class="z-punctuation z-separator z-rust">,</span> iw <span class="z-keyword z-operator z-arithmetic z-rust">+</span> N<span class="z-punctuation z-section z-group z-end z-rust">]</span></span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">        acc <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-path z-rust">E<span class="z-punctuation z-accessor z-rust">::</span></span>vmuladd<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>simd<span class="z-punctuation z-separator z-rust">,</span> i0<span class="z-punctuation z-separator z-rust">,</span> f0<span class="z-punctuation z-separator z-rust">,</span> acc</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">      </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">  </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust">
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust">  <span class="z-support z-function z-rust">vstore</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-operator z-bitwise z-rust">&amp;</span><span class="z-storage z-modifier z-rust">mut</span> out<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">[</span>ow <span class="z-keyword z-operator z-arithmetic z-rust">+</span> N<span class="z-punctuation z-separator z-rust">,</span> oc<span class="z-punctuation z-section z-group z-end z-rust">]</span></span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span><span class="z-punctuation z-separator z-rust">,</span> acc<span class="z-keyword z-operator z-rust">~</span>N</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></code></pre>
<p>Running the benchmarks, it's still fast - <em>yay!</em> It's much more efficient to run
two loops than to check if we're in bounds on every iteration.</p>
<h2 id="adding-back-the-other-variables">Adding back the other variables</h2>
<p>To add back padding, stride and dilation, without tanking the performance again,
I decided to use
<a href="https://rustc-dev-guide.rust-lang.org/backend/monomorph.html">compile-time monomorphization</a>
to eliminate the common zero-padding and/or unit stride/dilation cases. So I use
a technique I saw used in the original convolution implementation, added by
<a href="https://github.com/DrChat">Justin Moore</a>, to enable auto-vectorization for unit
stride convolutions. By adding an <code>if</code>-statement that checks if stride and
dilation are all <code>1</code>, we allow the compiler to
<a href="https://en.wikipedia.org/wiki/Constant_folding#Constant_propagation">constant propagate</a>
this value into that branch. The inner loop is extracted into a separate,
inlined function. This trick allows unstrided convolution to be auto-vectorized in the original,
non-SIMD implementation.</p>
<pre data-lang="rust" class="language-rust z-code"><code class="language-rust" data-lang="rust"><span class="z-source z-rust"><span class="z-keyword z-control z-rust">for</span> ow_block <span class="z-keyword z-operator z-rust">in</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">0</span><span class="z-keyword z-operator z-range z-rust">..</span>ow_blocks <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust">  <span class="z-storage z-type z-rust">let</span> ow <span class="z-keyword z-operator z-assignment z-rust">=</span> ow_block <span class="z-keyword z-operator z-arithmetic z-rust">*</span> ow_b <span class="z-keyword z-operator z-arithmetic z-rust">+</span> ow_start<span class="z-punctuation z-terminator z-rust">;</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust">
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust">  <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> Trick the compiler into constant propagating stride/dilation
</span></span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust">  <span class="z-meta z-annotation z-rust"><span class="z-punctuation z-definition z-annotation z-rust">#</span><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-variable z-annotation z-rust">allow</span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust">clippy::if_same_then_else</span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span>
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust">  <span class="z-keyword z-control z-rust">if</span> <span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-constant z-numeric z-integer z-decimal z-rust">1</span><span class="z-punctuation z-separator z-rust">,</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">1</span><span class="z-punctuation z-separator z-rust">,</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">1</span><span class="z-punctuation z-separator z-rust">,</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">1</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-keyword z-operator z-comparison z-rust">==</span> <span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>stride_h<span class="z-punctuation z-separator z-rust">,</span> stride_w<span class="z-punctuation z-separator z-rust">,</span> dilate_h<span class="z-punctuation z-separator z-rust">,</span> dilate_w</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">    <span class="z-support z-function z-rust">conv2d_inner</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust">      simd<span class="z-punctuation z-separator z-rust">,</span> <span class="z-keyword z-operator z-bitwise z-rust">&amp;</span>x<span class="z-punctuation z-separator z-rust">,</span> <span class="z-keyword z-operator z-bitwise z-rust">&amp;</span>weights<span class="z-punctuation z-separator z-rust">,</span> <span class="z-keyword z-operator z-bitwise z-rust">&amp;</span><span class="z-storage z-modifier z-rust">mut</span> out<span class="z-punctuation z-separator z-rust">,</span> bias<span class="z-punctuation z-separator z-rust">,</span> oh<span class="z-punctuation z-separator z-rust">,</span> ow<span class="z-punctuation z-separator z-rust">,</span> oc<span class="z-punctuation z-separator z-rust">,</span> ic_off<span class="z-punctuation z-separator z-rust">,</span> stride_h<span class="z-punctuation z-separator z-rust">,</span> stride_w<span class="z-punctuation z-separator z-rust">,</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust">      dilate_h<span class="z-punctuation z-separator z-rust">,</span> dilate_w<span class="z-punctuation z-separator z-rust">,</span> k_height<span class="z-punctuation z-separator z-rust">,</span> k_width<span class="z-punctuation z-separator z-rust">,</span> pad_h<span class="z-punctuation z-separator z-rust">,</span> pad_w<span class="z-punctuation z-separator z-rust">,</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust">    </span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">  </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span> <span class="z-keyword z-control z-rust">else</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">    <span class="z-support z-function z-rust">conv2d_inner</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust">      simd<span class="z-punctuation z-separator z-rust">,</span> <span class="z-keyword z-operator z-bitwise z-rust">&amp;</span>x<span class="z-punctuation z-separator z-rust">,</span> <span class="z-keyword z-operator z-bitwise z-rust">&amp;</span>weights<span class="z-punctuation z-separator z-rust">,</span> <span class="z-keyword z-operator z-bitwise z-rust">&amp;</span><span class="z-storage z-modifier z-rust">mut</span> out<span class="z-punctuation z-separator z-rust">,</span> bias<span class="z-punctuation z-separator z-rust">,</span> oh<span class="z-punctuation z-separator z-rust">,</span> ow<span class="z-punctuation z-separator z-rust">,</span> oc<span class="z-punctuation z-separator z-rust">,</span> ic_off<span class="z-punctuation z-separator z-rust">,</span> stride_h<span class="z-punctuation z-separator z-rust">,</span> stride_w<span class="z-punctuation z-separator z-rust">,</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust">      dilate_h<span class="z-punctuation z-separator z-rust">,</span> dilate_w<span class="z-punctuation z-separator z-rust">,</span> k_height<span class="z-punctuation z-separator z-rust">,</span> k_width<span class="z-punctuation z-separator z-rust">,</span> pad_h<span class="z-punctuation z-separator z-rust">,</span> pad_w<span class="z-punctuation z-separator z-rust">,</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust">    </span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">  </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></code></pre>
<p>The padding support is added back via a const generic <code>bool</code>, that sets the
padding to <code>0</code>. This allows the compiler to, once again, constant propagate it.</p>
<pre data-lang="rust" class="language-rust z-code"><code class="language-rust" data-lang="rust"><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">run_conv2d</span></span><span class="z-meta z-generic z-rust"><span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span><span class="z-comment z-block z-rust"><span class="z-punctuation z-definition z-comment z-rust">/*</span>...<span class="z-punctuation z-definition z-comment z-rust">*/</span></span>, <span class="z-storage z-modifier z-rust">const</span> PAD<span class="z-punctuation z-separator z-rust">:</span> <span class="z-storage z-type z-rust">bool</span><span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span><span class="z-comment z-block z-rust"><span class="z-punctuation z-definition z-comment z-rust">/*</span>...<span class="z-punctuation z-definition z-comment z-rust">*/</span></span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">  <span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span>...
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">  <span class="z-keyword z-control z-rust">if</span> <span class="z-keyword z-operator z-logical z-rust">!</span><span class="z-constant z-other z-rust">PAD</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">    pad_h <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">0</span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">    pad_w <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">0</span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">  </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre>
<p><strong>Nice and easy.</strong></p>
<p>Let's run the benchmark again!</p>
<pre data-lang="txt" class="language-txt z-code"><code class="language-txt" data-lang="txt"><span class="z-text z-plain">Benchmarking - conv2d-input_16x512x512_weight_16x3x3_stride_1
</span><span class="z-text z-plain">―――――――― Result ―――――――――
</span><span class="z-text z-plain">  Timing      full
</span><span class="z-text z-plain">  Samples     40
</span><span class="z-text z-plain">  Mean        8.136s (+3868%)
</span><span class="z-text z-plain">  Variance    75.115µs
</span><span class="z-text z-plain">  Median      8.042s (+3861%)
</span><span class="z-text z-plain">  Min         8.020s (+3890%)
</span><span class="z-text z-plain">  Max         8.341s (+3929%)
</span><span class="z-text z-plain">―――――――――――――――――――――――――
</span></code></pre>
<p>Oh. Oh dear. What happened?</p>
<h2 id="when-the-compiler-gets-it-wrong">When the compiler gets it wrong</h2>
<p>To explain what just happened I need to add another small background detail I
didn't mention before. To use modern SIMD features, the code uses runtime
feature selection with <a href="https://github.com/sarah-quinones/pulp">pulp</a>. The way
this works is that <code>pulp</code> annotates a function with something like
<code>#[target_feature(enable = "avx2")]</code>, based on the available features. This
tells the compiler it's allowed to use avx2 features, even if the target
wouldn't normally include avx2. However, only inlined functions will have the
features enabled and non-inlined function calls will not (<em>this is
foreshadowing</em>).</p>
<p>This is where <code>samply</code> starts becoming actually useful. Running it allows me to
see the assembly for each function and find the hotspots. <em>And this time they
are actually meaningful!</em> <code>samply</code> tells me, I'm spending all my time in the
line that calls the FMA and in the FMA itself. So I take a look at the assembly
and -<em>oh no!</em></p>
<pre data-lang="asm" class="language-asm z-code"><code class="language-asm" data-lang="asm"><span class="z-source z-assembly"><span class="z-keyword z-control z-assembly">movaps</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-variable z-parameter z-register z-assembly">xmm6</span><span class="z-source z-assembly">,</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly">x</span><span class="z-entity z-name z-function z-assembly">m</span><span class="z-entity z-name z-function z-assembly">m</span><span class="z-entity z-name z-function z-assembly">w</span><span class="z-entity z-name z-function z-assembly">o</span><span class="z-entity z-name z-function z-assembly">r</span><span class="z-entity z-name z-function z-assembly">d</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-source z-assembly">[</span><span class="z-variable z-parameter z-register z-assembly">rsp</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-source z-assembly">+</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-constant z-character z-hexadecimal z-assembly">0x2e0</span><span class="z-source z-assembly">]</span>
</span><span class="z-source z-assembly"><span class="z-keyword z-control z-assembly">movaps</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-variable z-parameter z-register z-assembly">xmm7</span><span class="z-source z-assembly">,</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly">x</span><span class="z-entity z-name z-function z-assembly">m</span><span class="z-entity z-name z-function z-assembly">m</span><span class="z-entity z-name z-function z-assembly">w</span><span class="z-entity z-name z-function z-assembly">o</span><span class="z-entity z-name z-function z-assembly">r</span><span class="z-entity z-name z-function z-assembly">d</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-source z-assembly">[</span><span class="z-variable z-parameter z-register z-assembly">rsp</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-source z-assembly">+</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-constant z-character z-hexadecimal z-assembly">0x2f0</span><span class="z-source z-assembly">]</span>
</span><span class="z-source z-assembly"><span class="z-keyword z-control z-assembly">movaps</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly">x</span><span class="z-entity z-name z-function z-assembly">m</span><span class="z-entity z-name z-function z-assembly">m</span><span class="z-entity z-name z-function z-assembly">w</span><span class="z-entity z-name z-function z-assembly">o</span><span class="z-entity z-name z-function z-assembly">r</span><span class="z-entity z-name z-function z-assembly">d</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-source z-assembly">[</span><span class="z-variable z-parameter z-register z-assembly">rsp</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-source z-assembly">+</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-constant z-character z-hexadecimal z-assembly">0x170</span><span class="z-source z-assembly">]</span><span class="z-source z-assembly">,</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-variable z-parameter z-register z-assembly">xmm15</span>
</span><span class="z-source z-assembly"><span class="z-keyword z-control z-assembly">movaps</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly">x</span><span class="z-entity z-name z-function z-assembly">m</span><span class="z-entity z-name z-function z-assembly">m</span><span class="z-entity z-name z-function z-assembly">w</span><span class="z-entity z-name z-function z-assembly">o</span><span class="z-entity z-name z-function z-assembly">r</span><span class="z-entity z-name z-function z-assembly">d</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-source z-assembly">[</span><span class="z-variable z-parameter z-register z-assembly">rsp</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-source z-assembly">+</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-constant z-character z-hexadecimal z-assembly">0x160</span><span class="z-source z-assembly">]</span><span class="z-source z-assembly">,</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-variable z-parameter z-register z-assembly">xmm14</span>
</span><span class="z-source z-assembly"><span class="z-keyword z-control z-assembly">movaps</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-variable z-parameter z-register z-assembly">xmm0</span><span class="z-source z-assembly">,</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly">x</span><span class="z-entity z-name z-function z-assembly">m</span><span class="z-entity z-name z-function z-assembly">m</span><span class="z-entity z-name z-function z-assembly">w</span><span class="z-entity z-name z-function z-assembly">o</span><span class="z-entity z-name z-function z-assembly">r</span><span class="z-entity z-name z-function z-assembly">d</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-source z-assembly">[</span><span class="z-variable z-parameter z-register z-assembly">rsp</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-source z-assembly">+</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-constant z-character z-hexadecimal z-assembly">0x180</span><span class="z-source z-assembly">]</span>
</span><span class="z-source z-assembly"><span class="z-keyword z-control z-assembly">movaps</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly">x</span><span class="z-entity z-name z-function z-assembly">m</span><span class="z-entity z-name z-function z-assembly">m</span><span class="z-entity z-name z-function z-assembly">w</span><span class="z-entity z-name z-function z-assembly">o</span><span class="z-entity z-name z-function z-assembly">r</span><span class="z-entity z-name z-function z-assembly">d</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-source z-assembly">[</span><span class="z-variable z-parameter z-register z-assembly">rsp</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-source z-assembly">+</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-constant z-character z-hexadecimal z-assembly">0xb0</span><span class="z-source z-assembly">]</span><span class="z-source z-assembly">,</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-variable z-parameter z-register z-assembly">xmm0</span>
</span><span class="z-source z-assembly"><span class="z-keyword z-control z-assembly">movaps</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-variable z-parameter z-register z-assembly">xmm0</span><span class="z-source z-assembly">,</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly">x</span><span class="z-entity z-name z-function z-assembly">m</span><span class="z-entity z-name z-function z-assembly">m</span><span class="z-entity z-name z-function z-assembly">w</span><span class="z-entity z-name z-function z-assembly">o</span><span class="z-entity z-name z-function z-assembly">r</span><span class="z-entity z-name z-function z-assembly">d</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-source z-assembly">[</span><span class="z-variable z-parameter z-register z-assembly">rsp</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-source z-assembly">+</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-constant z-character z-hexadecimal z-assembly">0x190</span><span class="z-source z-assembly">]</span>
</span><span class="z-source z-assembly"><span class="z-keyword z-control z-assembly">movaps</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-entity z-name z-function z-assembly">x</span><span class="z-entity z-name z-function z-assembly">m</span><span class="z-entity z-name z-function z-assembly">m</span><span class="z-entity z-name z-function z-assembly">w</span><span class="z-entity z-name z-function z-assembly">o</span><span class="z-entity z-name z-function z-assembly">r</span><span class="z-entity z-name z-function z-assembly">d</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-source z-assembly">[</span><span class="z-variable z-parameter z-register z-assembly">rsp</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-source z-assembly">+</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-constant z-character z-hexadecimal z-assembly">0xa0</span><span class="z-source z-assembly">]</span><span class="z-source z-assembly">,</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-variable z-parameter z-register z-assembly">xmm0</span>
</span><span class="z-source z-assembly"><span class="z-keyword z-control z-assembly">mov</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-variable z-parameter z-register z-assembly">rcx</span><span class="z-source z-assembly">,</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-variable z-parameter z-register z-assembly">rbx</span>
</span><span class="z-source z-assembly"><span class="z-keyword z-control z-assembly">lea</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-variable z-parameter z-register z-assembly">rbx</span><span class="z-source z-assembly">,</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-support z-function z-directive z-assembly">qword</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-source z-assembly">[</span><span class="z-variable z-parameter z-register z-assembly">rsp</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-source z-assembly">+</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-constant z-character z-hexadecimal z-assembly">0x320</span><span class="z-source z-assembly">]</span>
</span><span class="z-source z-assembly"><span class="z-keyword z-control z-assembly">mov</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-variable z-parameter z-register z-assembly">rdx</span><span class="z-source z-assembly">,</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-variable z-parameter z-register z-assembly">rbx</span>
</span><span class="z-source z-assembly"><span class="z-keyword z-control z-assembly">mov</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-variable z-parameter z-register z-assembly">r8</span><span class="z-source z-assembly">,</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-variable z-parameter z-register z-assembly">rdi</span>
</span><span class="z-source z-assembly"><span class="z-keyword z-control z-assembly">mov</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-variable z-parameter z-register z-assembly">r9</span><span class="z-source z-assembly">,</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-variable z-parameter z-register z-assembly">r14</span>
</span><span class="z-source z-assembly"><span class="z-keyword z-control z-assembly">call</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-constant z-character z-hexadecimal z-assembly">0x4edb0</span>
</span></code></pre>
<ul>
<li>Why is it using SSE registers instead of AVX registers?</li>
<li>Why is it putting them onto the stack?</li>
<li>It's using <code>call</code> to execute the
<a href="https://doc.rust-lang.org/beta/core/arch/x86_64/fn._mm256_fmadd_ps.html">_mm256_fmadd_ps</a>
intrinsic for some reason?</li>
</ul>
<p>Turns out: These things are linked. Coming up is what I think is a pretty
accurate guess of what happened here.</p>
<p>See, the compiler has a size limit for inlined functions. <code>#[inline(always)]</code>
tells the compiler to ignore the size limit, and <em>almost</em> all of my functions
were marked as <code>#[inline(always)]</code>. However, the <em>outermost</em> function <strong>was
not</strong>.</p>
<p>These are the steps I think happened next:</p>
<ul>
<li>Adding these inlined branches caused the size of the function to exceed
Rust's inlining limit</li>
<li>Rust outlined (is that a word?) the top-level function from <code>pulp</code>s wrapper
function, the one that is marked with <code>#[target_feature]</code></li>
<li>The compiler now treats my function as a regular function, causing it to
fall back to the default feature set (<code>x86-64-v1</code>)</li>
<li>This means 256-bit registers are no longer available in my function.</li>
<li>Since <code>_mm256_fmadd_ps</code> is an AVX2 instruction that requires 256-bit
registers, the compiler must now call it dynamically and transfer the data
via the stack. This is slow. <strong>Very</strong> slow.</li>
</ul>
<p>I'm somewhat unsure about that last step, maybe someone with more knowledge of
compiler internals can enlighten me on the actual reason the intrinsic is no
longer inlined.</p>
<p>Fortunately, the solution was much simpler than this chain of events: Annotate
the top-level function with <code>#[inline(always)]</code>.</p>
<pre data-lang="asm" class="language-asm z-code"><code class="language-asm" data-lang="asm"><span class="z-source z-assembly"><span class="z-keyword z-control z-assembly">vbroadcastss</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-variable z-parameter z-register z-assembly">ymm9</span><span class="z-source z-assembly">,</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-support z-function z-directive z-assembly">dword</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-source z-assembly">[</span><span class="z-variable z-parameter z-register z-assembly">r12</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-source z-assembly">+</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-variable z-parameter z-register z-assembly">r11</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-source z-assembly">*</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-constant z-character z-decimal z-assembly">1</span><span class="z-source z-assembly">]</span>
</span><span class="z-source z-assembly"><span class="z-keyword z-control z-assembly">lea</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-variable z-parameter z-register z-assembly">rcx</span><span class="z-source z-assembly">,</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-support z-function z-directive z-assembly">qword</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-source z-assembly">[</span><span class="z-variable z-parameter z-register z-assembly">r11</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-source z-assembly">+</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-variable z-parameter z-register z-assembly">r12</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-source z-assembly">*</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-constant z-character z-decimal z-assembly">1</span><span class="z-source z-assembly">]</span>
</span><span class="z-source z-assembly"><span class="z-entity z-name z-function z-assembly">v</span><span class="z-entity z-name z-function z-assembly">f</span><span class="z-entity z-name z-function z-assembly">m</span><span class="z-entity z-name z-function z-assembly">a</span><span class="z-entity z-name z-function z-assembly">d</span><span class="z-entity z-name z-function z-assembly">d</span><span class="z-entity z-name z-function z-assembly">2</span><span class="z-entity z-name z-function z-assembly">3</span><span class="z-entity z-name z-function z-assembly">1</span><span class="z-entity z-name z-function z-assembly">p</span><span class="z-entity z-name z-function z-assembly">s</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-variable z-parameter z-register z-assembly">ymm6</span><span class="z-source z-assembly">,</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-variable z-parameter z-register z-assembly">ymm8</span><span class="z-source z-assembly">,</span><span class="z-entity z-name z-function z-assembly"> </span><span class="z-variable z-parameter z-register z-assembly">ymm10</span>
</span></code></pre>
<p>Much better. And the benchmark?</p>
<pre data-lang="txt" class="language-txt z-code"><code class="language-txt" data-lang="txt"><span class="z-text z-plain">Benchmarking - conv2d-input_16x512x512_weight_16x3x3_stride_1
</span><span class="z-text z-plain">―――――――― Result ―――――――――
</span><span class="z-text z-plain">  Timing      full
</span><span class="z-text z-plain">  Samples     40
</span><span class="z-text z-plain">  Mean        230.12ms
</span><span class="z-text z-plain">  Variance    69.420µs
</span><span class="z-text z-plain">  Median      232.24ms
</span><span class="z-text z-plain">  Min         224.12ms
</span><span class="z-text z-plain">  Max         236.23ms
</span><span class="z-text z-plain">―――――――――――――――――――――――――
</span></code></pre>
<p>Nice!</p>
<h2 id="finishing-up-the-optimizations">Finishing up the optimizations</h2>
<p>Performance was good for unpadded convolutions, but would still have been
lackluster for padded ones, since we need to check if we are in padding <em>in
every single loop iteration</em>. To solve this, we can use the same technique we
used for the <code>out_width</code> earlier: All pixels that are more than <code>padding</code> away
from the edges are guaranteed to always be in bounds, so we can run one loop
from <code>padding_h</code> to <code>out_height - padding_h</code> and <code>padding_w</code> to
<code>width - padding_w</code> without bounds checks, then a second loop for the border
pixels that <em>does</em> do bounds checks. This is much faster than checking every
pixel, since most pixels are always in bounds.</p>
<pre data-lang="rust" class="language-rust z-code"><code class="language-rust" data-lang="rust"><span class="z-source z-rust"><span class="z-keyword z-control z-rust">if</span> <span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>pad_h<span class="z-punctuation z-separator z-rust">,</span> pad_w</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-keyword z-operator z-comparison z-rust">!=</span> <span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-constant z-numeric z-integer z-decimal z-rust">0</span><span class="z-punctuation z-separator z-rust">,</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">0</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust">  <span class="z-storage z-type z-rust">let</span> v_borders <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-constant z-numeric z-integer z-decimal z-rust">0</span><span class="z-keyword z-operator z-range z-rust">..</span>pad_h</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust">    <span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">chain</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>out_height<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">saturating_sub</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>pad_h</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-keyword z-operator z-range z-rust">..</span>out_height</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust">    <span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">cartesian_product</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-constant z-numeric z-integer z-decimal z-rust">0</span><span class="z-keyword z-operator z-range z-rust">..</span>out_width</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust">  <span class="z-storage z-type z-rust">let</span> h_borders <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-constant z-numeric z-integer z-decimal z-rust">0</span><span class="z-keyword z-operator z-range z-rust">..</span>out_height</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust">    <span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">cartesian_product</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-constant z-numeric z-integer z-decimal z-rust">0</span><span class="z-keyword z-operator z-range z-rust">..</span>pad_w</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">chain</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>out_width<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">saturating_sub</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>pad_w</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-keyword z-operator z-range z-rust">..</span>out_width</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust">
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust">  <span class="z-keyword z-control z-rust">for</span> <span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>oh<span class="z-punctuation z-separator z-rust">,</span> ow</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-keyword z-operator z-rust">in</span> v_borders<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">chain</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>h_borders</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">    <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span>...
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">  </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></code></pre>
<h2 id="final-thoughts">Final thoughts</h2>
<p>Modern CPUs are weird, and performance is not always obvious. Inlining is
fragile, and adding a single line of code can completely change the way your
program is compiled without you even noticing. Profilers aren't always helpful,
especially when your problem is more complex than something like using a slow
function or allocating memory too often. My tip is to just try to figure out
just when things start getting bad and maybe learn some basic assembly, so you
can spot things like way too many stack loads/stores (which indicates register
spilling).</p>
<p>I hope this helps someone deal with their performance issues a little bit more
quickly than I did.</p>
<p>Also big shout out once again to <a href="https://github.com/mstange/samply">samply</a>.
Even when the performance data didn't mean much, being able to easily view
assembly for any given function was very useful.</p>
<p>The final version of the code for this implementation can be found
<a href="https://github.com/tracel-ai/burn/blob/90ca4f3a9b61cf2f3c5a38cf6566684b7fb3b287/crates/burn-ndarray/src/ops/simd/conv.rs">here</a>.
And just for fun, here is the final benchmark after all optimizations, using
multi-threading:</p>
<pre data-lang="txt" class="language-txt z-code"><code class="language-txt" data-lang="txt"><span class="z-text z-plain">Benchmarking - conv2d-input_16x512x512_weight_16x3x3_stride_1
</span><span class="z-text z-plain">―――――――― Result ―――――――――
</span><span class="z-text z-plain">  Timing      full
</span><span class="z-text z-plain">  Samples     40
</span><span class="z-text z-plain">  Mean        42.731ms
</span><span class="z-text z-plain">  Variance    5.115µs
</span><span class="z-text z-plain">  Median      42.906ms
</span><span class="z-text z-plain">  Min         38.162ms
</span><span class="z-text z-plain">  Max         47.554ms
</span><span class="z-text z-plain">―――――――――――――――――――――――――
</span></code></pre>
<hr />
<footer class="footnotes">
<ol class="footnotes-list">
<li id="fn-1">
<p>I originally used an array of accumulators, but quickly found out that Rust
wasn't capable of optimizing the constant array indices into a set of
register accesses, and instead accessed the value from the stack. For the
sake of brevity, I omitted this version. <a href="#fr-1-1">↩</a></p>
</li>
<li id="fn-2">
<p>It's actually auto-vectorized using a trick we'll get to later <a href="#fr-2-1">↩</a></p>
</li>
<li id="fn-3">
<p><a href="https://chipsandcheese.com/p/zen-5s-2-ahead-branch-predictor-unit-how-30-year-old-idea-allows-for-new-tricks">It's two on Zen 5</a> <a href="#fr-3-1">↩</a></p>
</li>
<li id="fn-4">
<p>Thanks to <a href="https://www.reddit.com/r/rust/comments/1j2iqhq/comment/mft2pah/">/u/caelunshun for correcting me</a> <a href="#fr-4-1">↩</a></p>
</li>
</ol>
</footer>

        </div>
    </div>

        </section>
    </body>
</html>
